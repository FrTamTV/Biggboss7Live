<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party Dashboard</title>
    
    <!-- Load Tailwind CSS with the typography plugin for beautiful prose -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Google Fonts for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply the Inter font to the whole page */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Customize the scrollbar for a sleek look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; /* A dark gray to match the theme */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* A lighter gray for the thumb */
            border-radius: 10px;
            border: 2px solid #1f2937;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 antialiased">

    <!-- Main container with a professional-looking grid layout -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 lg:grid lg:grid-cols-3 lg:gap-8">

        <!-- Left Column: Video Player and details -->
        <div class="lg:col-span-2">
            <!-- Header Section -->
            <header class="mb-6 lg:mb-8">
                <!-- TODO: Update with your video's title -->
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tight">
                    Watch Party: Bigboss Season 7
                </h1>
                <!-- TODO: Update with a short description of your video -->
                <p class="mt-3 text-base sm:text-lg text-gray-400 max-w-2xl">
                    Join us for the live stream as we react to the latest drama and discuss
                    our favorite contestants. Don't forget to use the chat!
                </p>
            </header>

            <!-- Video Player Section -->
            <main>
                <div class="aspect-video bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
                    <!-- TODO: Replace the placeholder `src` URL with your actual YouTube or Vimeo embed link -->
                    <iframe 
                        src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        class="w-full h-full">
                    </iframe>
                </div>
            </main>

            <!-- Metadata and Info Section -->
            <section class="mt-8 bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold mb-3 text-white">About the Stream</h2>
                <div class="prose prose-invert max-w-none text-gray-300">
                    <!-- TODO: Update this content with the real description -->
                    <p>
                        This is a watch party of Bigboss Season 7. We'll be streaming live every Monday, Wednesday, and Friday at 7 PM IST.
                    </p>
                    <p>
                        Sometimes the stream may get interrupted due to technical issues, so please refresh this page or come back later if you experience problems.
                    </p>
                </div>
            </section>
        </div>

        <!-- Right Column: Live Chat Section -->
        <div class="lg:col-span-1 mt-8 lg:mt-0">
            <div class="bg-gray-800 rounded-xl shadow-2xl flex flex-col h-full max-h-[700px]">
                <header class="p-4 border-b border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">Live Chat</h3>
                        <!-- Online users counter -->
                        <div class="flex items-center text-sm text-green-400">
                            <span class="relative flex h-2 w-2 mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <span id="online-count">0</span> online
                        </div>
                    </div>
                </header>

                <!-- Chat Messages Display Area -->
                <div id="chat-messages" class="flex-grow p-4 overflow-y-auto custom-scrollbar space-y-4">
                    <!-- Chat messages will be dynamically added here -->
                </div>

                <!-- Chat Input Form -->
                <form id="chat-form" class="p-4 border-t border-gray-700">
                    <div class="relative">
                        <input type="text" id="chat-input" placeholder="Say something nice..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 pl-4 pr-12 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                        <button type="submit" class="absolute inset-y-0 right-0 flex items-center pr-3 text-indigo-400 hover:text-indigo-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.149 1.485.5.5 0 00.323-.016l1.32-.44a.5.5 0 00.334-.56v-2.925a1 1 0 00-.73-1.054.5.5 0 00-.14-.029l-1.32-.44a1 1 0 00-.334.56L10.894 2.553zM16.994 3a.5.5 0 00-.894 0l-7 14a.5.5 0 00.149.742.5.5 0 00.323-.016l1.32-.44a.5.5 0 00.334-.56V11.23a.5.5 0 00-.73-.25l-1.32-.44a.5.5 0 00-.334.56L16.994 3z" />
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    <script type="module">
        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Import Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase app and services
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const onlineCountElement = document.getElementById('online-count');
        
        let userId = null;
        let username = null;
        let unsubscribeOnline = null;
        let unsubscribeChat = null;

        /**
         * Signs in the user and starts listening for chat and online user updates.
         */
        const signInAndListen = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        };

        /**
         * Creates a new chat message element and appends it to the chat container.
         * @param {string} sender - The name of the message sender.
         * @param {string} message - The content of the message.
         * @param {string} time - The timestamp of the message.
         * @param {boolean} isSelf - True if the message is from the current user.
         */
        const addMessageToUI = (sender, message, time, isSelf) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-3 ${isSelf ? 'justify-end' : ''}`;

            const avatarDiv = document.createElement('img');
            avatarDiv.className = `w-8 h-8 rounded-full ${isSelf ? 'order-2' : ''}`;
            avatarDiv.alt = 'User Avatar';
            avatarDiv.src = `https://placehold.co/40x40/4b5563/e5e7eb?text=${sender[0]}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = isSelf ? 'text-right' : 'text-left';

            const senderSpan = document.createElement('span');
            senderSpan.className = `font-bold text-sm ${isSelf ? 'text-gray-400' : 'text-indigo-400'}`;
            senderSpan.textContent = sender;

            const textP = document.createElement('p');
            textP.className = `text-sm mt-1 p-2 rounded-lg break-words ${isSelf ? 'bg-indigo-600' : 'bg-gray-700'}`;
            textP.textContent = message;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-500 block';
            timeSpan.textContent = time;

            contentDiv.appendChild(senderSpan);
            contentDiv.appendChild(textP);
            contentDiv.appendChild(timeSpan);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        /**
         * Sets up real-time listener for chat messages from Firestore.
         */
        const setupChatListener = () => {
            if (!db) {
                console.error("Firestore database not initialized.");
                return;
            }
            const chatCollection = collection(db, `artifacts/${appId}/public/data/chat`);
            const chatQuery = query(chatCollection, orderBy('timestamp', 'asc'));

            unsubscribeChat = onSnapshot(chatQuery, (snapshot) => {
                // Clear the chat messages to re-render everything
                chatMessages.innerHTML = '';
                snapshot.forEach((doc) => {
                    const messageData = doc.data();
                    const isSelf = messageData.userId === userId;
                    const time = messageData.timestamp ? new Date(messageData.timestamp.toDate()).toLocaleTimeString() : '...';
                    addMessageToUI(messageData.username, messageData.message, time, isSelf);
                });
            });
        };

        /**
         * Sets up a real-time listener for online user count.
         */
        const setupOnlineCountListener = () => {
            if (!db) {
                console.error("Firestore database not initialized.");
                return;
            }
            const usersCollection = collection(db, `artifacts/${appId}/public/data/users`);

            // Listen for changes in the users collection
            unsubscribeOnline = onSnapshot(usersCollection, (snapshot) => {
                const now = serverTimestamp();
                let onlineCount = 0;
                
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Check if the user's last activity was within the last 5 minutes
                    if (userData.lastActive && now && now.seconds - userData.lastActive.seconds < 300) {
                        onlineCount++;
                    }
                });
                onlineCountElement.textContent = onlineCount;
            });
        };

        /**
         * Periodically updates the user's online status.
         */
        const updateOnlineStatus = async () => {
            if (userId) {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                await setDoc(userDocRef, {
                    userId: userId,
                    username: username,
                    lastActive: serverTimestamp(),
                }, { merge: true });
            }
        };

        // Handle the chat form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();

            if (messageText && userId && username) {
                try {
                    const chatCollection = collection(db, `artifacts/${appId}/public/data/chat`);
                    await addDoc(chatCollection, {
                        userId: userId,
                        username: username,
                        message: messageText,
                        timestamp: serverTimestamp(),
                    });
                    chatInput.value = '';
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }
        });

        // Main auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                username = `User_${user.uid.substring(0, 5)}`; // Simple username for demo
                
                // Unsubscribe from previous listeners if they exist
                if (unsubscribeChat) unsubscribeChat();
                if (unsubscribeOnline) unsubscribeOnline();

                // Set up real-time listeners
                setupChatListener();
                setupOnlineCountListener();

                // Update online status every minute
                updateOnlineStatus();
                setInterval(updateOnlineStatus, 60000);
            } else {
                console.log("User is signed out.");
            }
        });

        // Sign in the user on page load
        signInAndListen();
    </script>

</body>
</html>
